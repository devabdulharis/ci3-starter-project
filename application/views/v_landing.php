<?= $this->section('page_title') ?><?= APP_NAME; ?> - <?= APP_DESC; ?><?= $this->endSection() ?>
<?= $this->section('content') ?>
<section class="key-features" id="latar_belakang">
    <div class="container title">
        <div class="row align-items-center justify-content-center wow fadeInUp" data-wow-delay="0.10s">
            <div class="col-lg-10">
                <div class="card bg-primary-dark dashnum-card dashnum-card-small text-white overflow-hidden">
                    <div class="row container align-items-center justify-content-center">
                        <div class="col-sm-12 col-xl-6 text-center">
                            <h2 class="text-warning mt-sm-5 mt-xl-0">Apa sih maksud dan tujuan dibuatnya
                                <strong><?= APP_NAME; ?></strong>?
                            </h2>
                            <p class="mb-0"><?= APP_META; ?> bertujuan untuk menjadi tonggak dalam evaluasi, pelaporan,
                                dan
                                koordinasi
                                kegiatan yang berkaitan dengan penegakan peraturan dan ketertiban umum di wilayah Kab.
                                Cirebon.
                            </p>
                        </div>
                        <div class="col-md-12 col-xl-6 mt-2 text-center">
                            <span class="round bg-primary small"></span>
                            <span class="round bg-primary big"></span>
                            <img src="<?= base_url('assets/'); ?>images/polpp.svg">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.4s">
                    <div class="avtar avtar-xl bg-light-primary">
                        <i class="material-icons-two-tone text-primary f-34">insert_drive_file</i>
                    </div>
                    <h3 class="my-3">
                        <b>Menyelenggarakan Fungsi Satpol PP Kab.Cirebon dalam Evaluasi & Pelaporan</b>
                    </h3>
                    <p class="mb-0 text-muted">Membuat laporan yang akurat dan terperinci untuk memantau dan
                        meningkatkan kinerja Satpol PP.</p>
                </div>
            </div>
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.6s">
                    <div class="avtar avtar-xl bg-light-secondary">
                        <i class="material-icons-two-tone text-secondary f-34">create_new_folder</i>
                    </div>
                    <h3 class="my-3">
                        <b>Bank Data Pelanggar Perda di Kabupaten Cirebon</b>
                    </h3>
                    <p class="mb-0 text-muted">Membangun bank data yang komprehensif tentang pelanggaran peraturan
                        daerah (Perda) di Kabupaten Cirebon untuk mendukung pengambilan keputusan yang tepat.</p>
                </div>
            </div>
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.8s">
                    <div class="avtar avtar-xl bg-light-secondary">
                        <i class="material-icons-two-tone text-secondary f-34">map</i>
                    </div>
                    <h3 class="my-3">
                        <b>Pemetaan Sebaran Aparat Satpol PP Kabupaten Cirebon di 40 Kecamatan</b>
                    </h3>
                    <p class="mb-0 text-muted">Menyajikan pemetaan yang jelas dan akurat tentang lokasi dan distribusi
                        personel Satpol PP di seluruh wilayah Kabupaten Cirebon.</p>
                </div>
            </div>
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.4s">
                    <div class="avtar avtar-xl bg-light-primary">
                        <i class="material-icons-two-tone text-primary f-34">account_tree</i>
                    </div>
                    <h3 class="my-3">
                        <b>Koordinasi Kegiatan dalam Menjalankan Tugas dan Fungsi Satpol PP Kab Cirebon</b>
                    </h3>
                    <p class="mb-0 text-muted">Memfasilitasi koordinasi yang efisien antara berbagai unit dan personel
                        Satpol PP untuk memastikan sinergi dalam menjalankan tugas dan fungsi mereka.</p>
                </div>
            </div>
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.6s">
                    <div class="avtar avtar-xl bg-light-secondary">
                        <i class="material-icons-two-tone text-secondary f-34">data_usage</i>
                    </div>
                    <h3 class="my-3">
                        <b>Sebagai Data Acuan dalam Pembuatan Laporan Pertanggungjawaban</b>
                    </h3>
                    <p class="mb-0 text-muted">Menyediakan data yang valid dan terpercaya sebagai dasar untuk pembuatan
                        laporan pertanggungjawaban dan kebutuhan informasi lainnya bagi pimpinan dan SKPD terkait.</p>
                </div>
            </div>
            <div class="col-sm-6 col-lg-4">
                <div class="features-block text-center wow fadeInUp" data-wow-delay="0.8s">
                    <div class="avtar avtar-xl bg-light-secondary">
                        <i class="material-icons-two-tone text-secondary f-34">list_alt</i>
                    </div>
                    <h3 class="my-3">
                        <b>Masterplan Kondisi TIBUM dan Ketenteraman Masyarakat serta Perlindungan Masyarakat</b>
                    </h3>
                    <p class="mb-0 text-muted">Membantu dalam perencanaan dan pelaksanaan masterplan untuk menjaga
                        ketertiban umum, ketenteraman masyarakat, dan perlindungan masyarakat secara holistik di
                        Kab Cirebon.</p>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="key-features bg-light-secondary" id="publik">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 col-xl-12">
                                <h2 class="my-3 text-center">Dasbor Informasi Publik</h2>
                                <p class="text-center">Bertujuan untuk menjawab tuntutan akan pelayanan publik yang
                                    berkualitas
                                    melalui
                                    penyediaan data dan sistem informasi yang handal, dengan harapan dapat memberikan
                                    kontribusi positif
                                    dalam mewujudkan ketertiban, ketentraman, dan perlindungan masyarakat di Kabupaten
                                    Cirebon.</p>
                            </div>
                        </div>
                        <hr class="mb-5 mt-3">
                        <div class="row g-4">
                            <div class="col-sm-4">
                                <div class="list-group" id="list-tab" role="tablist">
                                    <a class="list-group-item list-group-item-action active"
                                        onclick="loadGeoJSON()"
                                        id="list-pegawai-list" data-bs-toggle="tab" href="#list-pegawai" role="tab"
                                        aria-controls="list-pegawai" aria-selected="true">SEBARAN PEGAWAI PER
                                        KECAMATAN</a>
                                    <a class="list-group-item list-group-item-action" id="list-kegiatan-list"
                                        data-bs-toggle="tab" href="#list-kegiatan" role="tab"
                                        aria-controls="list-kegiatan" onclick="load_data_tibum()">DATA KEGIATAN
                                        PENERTIBAN UMUM</a>
                                    <a class="list-group-item list-group-item-action" id="list-surat-list"
                                        data-bs-toggle="tab" href="#list-surat" role="tab"
                                        aria-controls="list-surat">DATA SURAT MASUK & PENGADUAN</a>
                                    <a class="list-group-item list-group-item-action" id="list-linmas-list"
                                        data-bs-toggle="tab" href="#list-linmas" role="tab" aria-controls="list-linmas"
                                        onclick="showChartLinmasByAction('kecamatan', null, 'aparatLinmasChart');">DATA
                                        SEBARAN APARAT LINMAS</a>
                                    <a class="list-group-item list-group-item-action" id="list-siskamling-list"
                                        data-bs-toggle="tab"
                                        onclick="showChartSiskamlingByAction('kecamatan', null, 'siskamlingChart');"
                                        href="#list-siskamling" role="tab" aria-controls="list-siskamling">DATA SEBARAN
                                        POS SISKAMLING</a>
                                    <a class="list-group-item list-group-item-action" id="list-perda-list"
                                        data-bs-toggle="tab" onclick="load_perda('perda')" href="#list-perda" role="tab"
                                        aria-controls="list-perda">DATA
                                        PERDA/PERKADA</a>
                                </div>
                            </div>
                            <div class="col-sm-8 bs-primary">
                                <div class="tab-content" id="nav-tabContent">
                                    <div class="tab-pane fade show active" id="list-pegawai" role="tabpanel"
                                        aria-labelledby="list-pegawai-list">
                                        <div id="svg-map"></div>
                                        <div id="summary" class="summary-box">
                                            <div class="summary-item">
                                                <span class="label">Pegawai di Kab. Cirebon:</span>
                                                <span class="value" id="total-cirebon">0</span>
                                            </div>
                                            <div class="summary-item">
                                                <span class="label">Pegawai di luar Kab. Cirebon:</span>
                                                <span class="value" id="total-luar">0</span>
                                            </div>
                                            <div class="summary-item total">
                                                <span class="label">Total Seluruh Pegawai:</span>
                                                <span class="value" id="total-keseluruhan">0</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="list-kegiatan" role="tabpanel"
                                        aria-labelledby="list-kegiatan-list">
                                        <div class="table-border-style">
                                            <div class="dt-responsive table-responsive">
                                                <table class="table table-striped table-bordered nowrap"
                                                    id="data_tibum">
                                                    <thead>
                                                        <tr>
                                                            <th>NO</th>
                                                            <th>Tanggal</th>
                                                            <th>Tipe</th>
                                                            <th>Tempat</th>
                                                            <th>Nama Kegiatan</th>
                                                            <th>Kec</th>
                                                            <th>Desa</th>
                                                            <th>Status</th>
                                                            <th>JML Personil</th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="list-surat" role="tabpanel"
                                        aria-labelledby="list-surat-list">
                                        <canvas id="suratMasukChart"></canvas>
                                    </div>
                                    <div class="tab-pane fade" id="list-linmas" role="tabpanel"
                                        aria-labelledby="list-linmas-list">
                                        <p align="center" id="aparatLinmasChart"></p>
                                    </div>
                                    <div class="tab-pane fade" id="list-siskamling" role="tabpanel"
                                        aria-labelledby="list-siskamling-list">
                                        <p align="center" id="siskamlingChart"></p>
                                    </div>
                                    <div class="tab-pane fade" id="list-perda" role="tabpanel">
                                        <div class="table-border-style">
                                            <div class="dt-responsive table-responsive">
                                                <h3 align="center">Data Peraturan Daerah</h3>
                                                <table class="table table-striped table-bordered nowrap"
                                                    id="data_perda">
                                                    <thead>
                                                        <tr>
                                                            <th>NO</th>
                                                            <th>Nomor</th>
                                                            <th>Tahun</th>
                                                            <th>Tipe</th>
                                                            <th>Tentang</th>
                                                            <th>Memuat Sanksi?</th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div id="map-popup" style="
    position: absolute;
    display: none;
    background: rgba(255,255,255,0.95);
    border: 1px solid #ccc;
    padding: 8px 12px;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 13px;
    pointer-events: none;
    z-index: 9999;
"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadGeoJSON(); // ini dipanggil setelah DOM siap
    });

    async function loadGeoJSON() {
        try {
            const [geoRes, pegawaiRes] = await Promise.all([
                fetch('<?= base_url('landing/get_kabupaten_json') ?>'),
                fetch('<?= base_url('landing/get_pegawai_by_kecamatan') ?>')
            ]);

            const geojson = await geoRes.json();
            const pegawaiData = await pegawaiRes.json();

            const dataPegawai = {};
            pegawaiData.kecamatan_names.forEach((label, i) => {
                dataPegawai[label.toUpperCase()] = pegawaiData.dataPegawai[i]; // Uppercase
            });

            const kecamatanMap = new Map();
            geojson.features.forEach(feature => {
                const kecamatan = feature.properties.wadmkc.toUpperCase(); // Pastikan sama formatnya
                if (!kecamatanMap.has(kecamatan)) {
                    kecamatanMap.set(kecamatan, {
                        features: [],
                        color: '',
                        props: feature.properties
                    });
                }
                kecamatanMap.get(kecamatan).features.push(feature);
            });

            const bounds = geojson.features.reduce((acc, feature) => {
                const coords = feature.geometry.coordinates.flat(Infinity);
                const longs = coords.filter((_, i) => i % 2 === 0);
                const lats = coords.filter((_, i) => i % 2 === 1);
                return {
                    minX: Math.min(acc.minX, ...longs),
                    maxX: Math.max(acc.maxX, ...longs),
                    minY: Math.min(acc.minY, ...lats),
                    maxY: Math.max(acc.maxY, ...lats)
                };
            }, {
                minX: Infinity,
                maxX: -Infinity,
                minY: Infinity,
                maxY: -Infinity
            });

            const svgWidth = 800;
            const svgHeight = 600;
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);
            svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

            const colors = generateUniqueColors(kecamatanMap.size);

            let colorIndex = 0;
            let totalPegawaiKabCirebon = 0;
            let totalPegawaiDiluarKabCirebon = dataPegawai['DILUAR KAB. CIREBON'] || 0;

            kecamatanMap.forEach((kecamatanData, kecamatanName) => {
                const color = colors[colorIndex++];
                kecamatanData.color = color;

                const jumlah = dataPegawai[kecamatanName] || 0;
                totalPegawaiKabCirebon += jumlah;

                kecamatanData.features.forEach(feature => {
                    const paths = [];
                    const polygons = [];

                    if (feature.geometry.type === 'Polygon') {
                        const projected = projectCoordinates(
                            feature.geometry.coordinates[0],
                            bounds,
                            svgWidth,
                            svgHeight
                        );
                        paths.push(createPath(projected));
                        polygons.push(projected);
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            const projected = projectCoordinates(
                                polygon[0],
                                bounds,
                                svgWidth,
                                svgHeight
                            );
                            paths.push(createPath(projected));
                            polygons.push(projected);
                        });
                    }

                    paths.forEach((pathData, i) => {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        path.setAttribute("d", pathData);
                        path.setAttribute("class", "region");
                        path.setAttribute("fill", color);
                        path.setAttribute("data-kecamatan", kecamatanName);

                        const popup = document.getElementById('map-popup');

                        path.addEventListener('mousemove', (e) => {
                            popup.innerHTML = `
                            <strong>${kecamatanName}</strong><br>
                            Kode: ${feature.properties.kdcpum || '-'}<br>
                            Kabupaten: ${feature.properties.wadmkk || 'Cirebon'}<br>
                            Provinsi: ${feature.properties.wadmpr || 'Jawa Barat'}<br>
                            Pegawai: ${jumlah}
                        `;
                            popup.style.left = `${e.pageX + 10}px`;
                            popup.style.top = `${e.pageY + 10}px`;
                            popup.style.display = 'block';
                            popup.classList.add('show');
                        });

                        path.addEventListener('mouseleave', () => {
                            popup.classList.remove('show');
                            setTimeout(() => {
                                popup.style.display = 'none';
                            }, 200); // Sesuai dengan transition durasi
                        });

                        svg.appendChild(path);

                        // Tambahkan label jumlah di tengah wilayah (opsional)
                        const projected = polygons[i];
                        const centroid = projected.reduce((acc, point) => {
                            acc.x += point[0];
                            acc.y += point[1];
                            return acc;
                        }, {
                            x: 0,
                            y: 0
                        });
                        centroid.x /= projected.length;
                        centroid.y /= projected.length;

                        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        text.setAttribute("x", centroid.x);
                        text.setAttribute("y", centroid.y);
                        text.setAttribute("text-anchor", "middle");
                        text.setAttribute("alignment-baseline", "middle");
                        text.setAttribute("fill", "#000");
                        text.setAttribute("font-size", "12");
                        text.setAttribute("pointer-events", "none");
                        text.setAttribute("stroke", "#fff");
                        text.setAttribute("stroke-width", "2");
                        text.textContent = jumlah;

                        svg.appendChild(text);
                    });
                });
            });

            // Log perbandingan kecamatan GeoJSON vs Pegawai
            const geoKecamatanNames = Array.from(kecamatanMap.keys());
            const dataKecamatanNames = Object.keys(dataPegawai);

            // Yang cocok
            // const matched = geoKecamatanNames.filter(name => dataKecamatanNames.includes(name));
            // console.log("✅ KECAMATAN COCOK:", matched);

            // // Yang ada di GeoJSON tapi tidak di data pegawai
            // const geoOnly = geoKecamatanNames.filter(name => !dataKecamatanNames.includes(name));
            // console.warn("❌ HANYA DI GEOJSON:", geoOnly);

            // // Yang ada di data pegawai tapi tidak di GeoJSON
            // const pegawaiOnly = dataKecamatanNames.filter(name => !geoKecamatanNames.includes(name));
            // console.warn("❌ HANYA DI DATA PEGAWAI:", pegawaiOnly);

            let totalKeseluruhan = totalPegawaiDiluarKabCirebon + totalPegawaiKabCirebon;
            document.getElementById('total-cirebon').textContent = totalPegawaiKabCirebon;
            document.getElementById('total-luar').textContent = totalPegawaiDiluarKabCirebon;
            document.getElementById('total-keseluruhan').textContent = totalKeseluruhan;
            document.getElementById('svg-map').innerHTML = '';
            document.getElementById('svg-map').appendChild(svg);

        } catch (error) {
            console.error('Error loading GeoJSON or Pegawai data:', error);
            document.getElementById('svg-map').innerHTML = `
            <div style="padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border-radius: 5px;">
                <p style="font-weight: bold;">Gagal memuat data peta</p>
                <p>Pastikan file GeoJSON dan endpoint tersedia.</p>
                <p>Error: ${error.message}</p>
            </div>
        `;
        }
    }
</script>
<?= $this->endSection() ?>
<?= $this->extend('layouts/frame_landing') ?>
